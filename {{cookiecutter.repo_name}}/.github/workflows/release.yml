name: Release

on:
  push:
    branches:
      - main
permissions:
  id-token: write # Required for OIDC with AWS
  contents: read # For checkout

env:
  RELEASE_PYTHON_VERSION: "3.11" # Python version used for the release & lambda bundles

jobs:
  conventional-commits:
    name: Conventional commits style enforcement
    runs-on: ubuntu-latest
    steps:
      - name: Checkout git repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Setup python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Upgrade pip
        run: |
          pip install --constraint=.github/workflows/constraints.txt pip
          pip --version
      - name: Install gitlint
        run: |
          pip install --constraint=.github/workflows/constraints.txt gitlint
          gitlint --version
      - name: Run gitlint for the latest commit
        run: gitlint

  release:
    name: Release
    needs: conventional-commits
    runs-on: ubuntu-latest
    concurrency: release
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: {{ cookiecutter.aws_region }}
          role-to-assume: {{ cookiecutter.aws_oidc_role_arn }}
          role-session-name: {{ cookiecutter.aws_oidc_session_name }}

      - name: Get AWS CodeArtifact Auth Token
        run: |
          export $(printf "AWS_ACCESS_KEY_ID=%s AWS_SECRET_ACCESS_KEY=%s AWS_SESSION_TOKEN=%s" \
          $(aws sts assume-role \
          --role-arn {{ cookiecutter.aws_admin_role_arn }} \
          --external-id {{ cookiecutter.aws_admin_role_external_id }} \
          --role-session-name {{ cookiecutter.aws_admin_session_name }} \
          --query "Credentials.[AccessKeyId,SecretAccessKey,SessionToken]" \
          --output text))

          CODEARTIFACT_ENDPOINT=$(aws codeartifact get-repository-endpoint \
          --domain {{ cookiecutter.aws_codeartifact_domain }} \
          --domain-owner {{ cookiecutter.aws_codeartifact_domain_owner }} \
          --repository {{ cookiecutter.aws_codeartifact_pypi_repo_name }} \
          --format pypi --output text)

          CODEARTIFACT_TOKEN=$(aws codeartifact get-authorization-token \
          --domain {{ cookiecutter.aws_codeartifact_domain }} \
          --domain-owner {{ cookiecutter.aws_codeartifact_domain_owner }} \
          --query authorizationToken --output text)

          echo "CODEARTIFACT_ENDPOINT=${CODEARTIFACT_ENDPOINT}" >> $GITHUB_ENV
          echo "CODEARTIFACT_TOKEN=${CODEARTIFACT_TOKEN}" >> $GITHUB_ENV

      - name: Check out the repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{"{{"}} env.RELEASE_PYTHON_VERSION {{"}}"}}

      - name: Upgrade pip
        run: |
          pip install --constraint=.github/workflows/constraints.txt pip
          pip --version

      - name: Install Poetry
        run: |
          pip install --constraint=.github/workflows/constraints.txt poetry
          poetry --version

      - name: Check if there is a parent commit
        id: check-parent-commit
        run: |
          echo "{sha}=$(git rev-parse --verify --quiet HEAD^)" >> $GITHUB_OUTPUT

      - name: Configure CodeArtifact Auth for Poetry
        # This is for fetching packages from private repo. The repo URL has to be provided in the
        # `tool.poetry.source` section of pyproject.toml (and it must include the 'simple/' suffix
        # which is required for pulling from CodeArtifact repos)
        run: |
          poetry config http-basic.{{ cookiecutter.aws_codeartifact_pypi_repo_name }} aws ${CODEARTIFACT_TOKEN}

      - name: Python Semantic Release
        id: release
        uses: python-semantic-release/python-semantic-release@v8
        with:
          github_token: ${{"{{"}} secrets.GH_SEMANTIC_RELEASE_PAT {{"}}"}}

      - name: Publish package distributions to GitHub Releases
        uses: python-semantic-release/upload-to-gh-release@main
        if: steps.release.outputs.released == 'true'
        with:
          github_token: ${{"{{"}} secrets.GH_SEMANTIC_RELEASE_PAT {{"}}"}}

{% if cookiecutter.publish_to_codeartifact == 'Yes' %}
      - name: Publish to CodeArtifact
        run: |
          poetry config repositories.publish-target ${CODEARTIFACT_ENDPOINT}
          # For publishing to a CodeArtifact repo, the 'simple/' suffix must be **omitted**
          poetry config http-basic.publish-target aws ${CODEARTIFACT_TOKEN}

          poetry build
          poetry publish -r publish-target
{% endif -%}
{% if cookiecutter.create_lambda_bundles == 'Yes' %}
      - name: Create lambda bundles
        if: steps.release.outputs.released == 'true'
        run: |
          # PIP_EXTRA_INDEX_URL is used by pip to fetch requirements from private PyPi repo,
          # it must include the 'simple/' suffix for pulling the packages from CodeArtifact repos
          PIP_EXTRA_INDEX_URL=$(sed -e "s^//^//aws:${CODEARTIFACT_TOKEN}@^" <<<"${CODEARTIFACT_ENDPOINT}simple/")

          poetry export --format=requirements.txt --without-hashes -o requirements.txt
          poetry build --format wheel

          pip install --no-compile --no-deps -r requirements.txt --extra-index-url ${PIP_EXTRA_INDEX_URL} -t layer
          pip install --no-compile --no-deps ./dist/*.whl -t lambda

          mkdir lambda-bundles

          (cd lambda && zip -r ../lambda-bundles/{{ cookiecutter.project_name }}-${NEW_VERSION}-py${RELEASE_PYTHON_VERSION}.zip .)
          (cd layer && zip -r ../lambda-bundles/{{ cookiecutter.project_name }}-${NEW_VERSION}-layer-py${RELEASE_PYTHON_VERSION}.zip .)
        env:
          NEW_VERSION: ${{"{{"}} steps.release.outputs.version {{"}}"}}

      - name: Upload lambda bundles to S3
        if: steps.release.outputs.released == 'true'
        run: |
          export $(printf "AWS_ACCESS_KEY_ID=%s AWS_SECRET_ACCESS_KEY=%s AWS_SESSION_TOKEN=%s" \
          $(aws sts assume-role \
          --role-arn {{ cookiecutter.aws_admin_role_arn }} \
          --external-id {{ cookiecutter.aws_admin_role_external_id }} \
          --role-session-name {{ cookiecutter.aws_admin_session_name }} \
          --query "Credentials.[AccessKeyId,SecretAccessKey,SessionToken]" \
          --output text))

          aws s3 cp --recursive --include "*.zip" lambda-bundles/ {{ cookiecutter.aws_artifacts_s3url }}

      - name: Archive lambda bundles
        uses: actions/upload-artifact@v3
        with:
          name: lambda-bundles
          path: lambda-bundles
{% endif -%}
